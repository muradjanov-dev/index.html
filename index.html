<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitob Challenge</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- React & Babel for in-browser JSX -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts for the animated title -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #182230);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Gradient animation for the title in the main app */
        .animated-title {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(90deg, #818cf8, #f472b6, #60a5fa, #818cf8);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: text-gradient-flow 4s linear infinite;
        }
        @keyframes text-gradient-flow {
            to {
                background-position: 200% center;
            }
        }
        /* NEW: Styles for the initial loading screen animation */
        .loading-title {
            font-family: 'Poppins', sans-serif;
            font-size: 2.25rem; /* 36px */
            line-height: 2.5rem; /* 40px */
            font-weight: 700;
            color: var(--tg-theme-text-color, #ffffff);
            overflow: hidden; /* Ensures the text is not seen before the animation */
            border-right: .15em solid var(--tg-theme-button-color, #3390ec); /* The typewriter cursor */
            white-space: nowrap; /* Keeps the content on a single line */
            margin: 0 auto; /* Gives that scrolling effect as the typing happens */
            letter-spacing: .1em; /* Adjust as needed */
            animation:
                typing 2.5s steps(30, end),
                blink-caret .75s step-end infinite;
        }

        /* The typing effect */
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        /* The typewriter cursor effect */
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--tg-theme-button-color, #3390ec); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        const { useState, useEffect } = React;

        // --- Icon Components ---
        const BookIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2 h-5 w-5"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-4 w-4"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
        const CalendarIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const SparklesIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3L9.5 8.5 4 11l5.5 2.5L12 19l2.5-5.5L20 11l-5.5-2.5z"/></svg>;

        // --- Helper Components ---
        const Spinner = ({ size = 'h-5 w-5' }) => (
            <div className="flex justify-center items-center">
                <div className={`animate-spin rounded-full border-t-2 border-b-2 border-white ${size}`}></div>
            </div>
        );

        const LoadingScreen = () => (
            <div className="flex items-center justify-center h-screen">
                <h1 className="loading-title">Kitob Challenge</h1>
            </div>
        );

        // --- Main Application Component ---
        const MainApp = ({ user, books, onLogReading, onAddNewBook, onDeleteBook }) => {
            const [dailyLogModalOpen, setDailyLogModalOpen] = useState(false);
            const [insightsModalOpen, setInsightsModalOpen] = useState(false);
            const [selectedBookForInsights, setSelectedBookForInsights] = useState(null);
            const [report, setReport] = useState(null);

            const handleLogConfirm = async (logData) => {
                const newReport = await onLogReading(logData);
                if (newReport) {
                    setReport(newReport);
                }
            };
            
            const openInsights = (book) => {
                setSelectedBookForInsights(book);
                setInsightsModalOpen(true);
            };

            return (
                <React.Fragment>
                    {dailyLogModalOpen && (
                        <DailyLogModal
                            books={books}
                            onClose={() => setDailyLogModalOpen(false)}
                            onConfirm={handleLogConfirm}
                            onAddNewBook={onAddNewBook}
                        />
                    )}
                    {insightsModalOpen && (
                        <BookInsightsModal
                            book={selectedBookForInsights}
                            onClose={() => setInsightsModalOpen(false)}
                        />
                    )}
                    <div className="p-4 sm:p-6 md:p-8">
                        <div className="max-w-4xl mx-auto">
                            <header className="mb-8 flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl sm:text-4xl font-bold animated-title">
                                        Kitob Challenge
                                    </h1>
                                    <p style={{color: 'var(--tg-theme-hint-color, #999999)'}} className="mt-1">Welcome, {user.fullName.split(' ')[0]}!</p>
                                </div>
                            </header>
                            
                            <section className="text-center my-8 md:my-12 min-h-[250px] flex flex-col justify-center items-center">
                                {report ? (
                                   <div className="w-full p-6 rounded-xl shadow-lg animate-fade-in" style={{backgroundColor: 'var(--tg-theme-secondary-bg-color, #2a3542)'}}>
                                       <h2 className="text-2xl font-bold text-center mb-4 flex items-center justify-center"><SparklesIcon className="h-6 w-6 mr-2" style={{color: '#FFD700'}} /> Latest Reading Report</h2>
                                       <div className="text-center space-y-2">
                                           <p className="text-xl font-semibold">{report.userName}</p>
                                           <p className="text-lg" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>{report.dayNumber}-day reading</p>
                                           <p className="text-lg font-medium">{report.book.title} - <span className="font-bold">{report.book.pagesRead}/{report.book.totalPages} pages</span></p>
                                           <p className="text-md mt-3 italic">"{report.motivation}"</p>
                                       </div>
                                       <button onClick={() => setDailyLogModalOpen(true)} className="mt-6 text-white font-bold px-5 py-2 rounded-md flex items-center transition-colors mx-auto" style={{backgroundColor: 'var(--tg-theme-button-color, #3390ec)'}}>
                                            Log Another Session
                                        </button>
                                   </div>
                                ) : (
                                    <div className="animate-fade-in">
                                        <button onClick={() => setDailyLogModalOpen(true)} className="text-white font-bold py-6 px-10 rounded-xl flex flex-col items-center transition-transform hover:scale-105 shadow-lg" style={{backgroundColor: 'var(--tg-theme-button-color, #3390ec)'}}>
                                            <CalendarIcon className="h-10 w-10 mb-2" />
                                            <span className="text-2xl">Log Daily Reading</span>
                                        </button>
                                    </div>
                                )}
                            </section>

                            <main>
                                <h2 className="text-2xl font-bold mb-4 flex items-center"><BookIcon /> My Library</h2>
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {books.length > 0 ? books.map(book => (
                                        <div key={book.id} className="p-4 rounded-xl flex flex-col justify-between cursor-pointer" style={{backgroundColor: 'var(--tg-theme-secondary-bg-color, #2a3542)'}} onClick={() => openInsights(book)}>
                                            <div>
                                                <h3 className="font-bold text-lg">{book.title}</h3>
                                                <p className="text-sm mb-2" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>{book.author}</p>
                                                <div className="w-full rounded-full h-2.5" style={{backgroundColor: 'var(--tg-theme-bg-color, #182230)'}}>
                                                    <div className="h-2.5 rounded-full" style={{ width: `${(book.pagesRead / book.totalPages) * 100}%`, backgroundColor: 'var(--tg-theme-button-color, #3390ec)' }}></div>
                                                </div>
                                                <p className="text-right text-xs mt-1" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>{book.pagesRead || 0} / {book.totalPages} pages</p>
                                            </div>
                                            <button onClick={(e) => {e.stopPropagation(); onDeleteBook(book.id)}} className="self-end mt-2 p-1 rounded-full" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>
                                                <TrashIcon />
                                            </button>
                                        </div>
                                    )) : (
                                        <p className="text-center py-8 sm:col-span-2 lg:col-span-3" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>Your library is empty. Add a book through the "Log Daily Reading" button.</p>
                                    )}
                                </div>
                            </main>
                        </div>
                    </div>
                </React.Fragment>
            );
        };

        // --- Daily Log Modal ---
        const DailyLogModal = ({ books, onClose, onConfirm, onAddNewBook }) => {
            const [step, setStep] = useState(1);
            const [dayNumber, setDayNumber] = useState('');
            const [selectedBook, setSelectedBook] = useState(null);
            const [pagesRead, setPagesRead] = useState('');
            const [isConfirming, setIsConfirming] = useState(false);
            const [addNewBookModalOpen, setAddNewBookModalOpen] = useState(false);

            const handleBookSelect = (book) => {
                setSelectedBook(book);
                setStep(3);
            };

            const handleAddNewBook = async (newBookData) => {
                const newBook = await onAddNewBook(newBookData);
                setAddNewBookModalOpen(false);
                if (newBook) {
                    handleBookSelect(newBook);
                }
            };
            
            const handleConfirmLog = async () => {
                setIsConfirming(true);
                await onConfirm({ dayNumber, bookId: selectedBook.id, pagesRead: parseInt(pagesRead) });
                setIsConfirming(false);
                onClose();
            };

            return (
                <React.Fragment>
                    {addNewBookModalOpen && (
                        <AddNewBookModal onClose={() => setAddNewBookModalOpen(false)} onConfirm={handleAddNewBook} />
                    )}
                    <div className="fixed inset-0 flex justify-center items-center p-4 z-50" style={{backgroundColor: 'rgba(0,0,0,0.7)'}}>
                        <div className="w-full max-w-lg p-6 rounded-xl relative" style={{backgroundColor: 'var(--tg-theme-secondary-bg-color, #2a3542)'}}>
                            <h2 className="text-2xl font-bold mb-6 text-center">Log Your Reading</h2>

                            {step === 1 && (
                                <div>
                                    <label className="block text-lg font-semibold mb-2">1. Which day are you reading?</label>
                                    <input type="number" value={dayNumber} onChange={e => setDayNumber(e.target.value)} placeholder="e.g., 79" className="w-full p-3 rounded-md border-0 outline-none" style={{backgroundColor: 'var(--tg-theme-bg-color, #182230)'}} />
                                    <div className="flex justify-end mt-6">
                                        <button onClick={() => setStep(2)} disabled={!dayNumber} className="text-white font-bold px-6 py-2 rounded-md transition-colors" style={{backgroundColor: 'var(--tg-theme-button-color, #3390ec)'}}>Next</button>
                                    </div>
                                </div>
                            )}

                            {step === 2 && (
                                <div>
                                    <label className="block text-lg font-semibold mb-2">2. Which book are you reading?</label>
                                    <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                        {books.map(book => (
                                            <div key={book.id} onClick={() => handleBookSelect(book)} className="p-3 rounded-lg cursor-pointer" style={{backgroundColor: 'var(--tg-theme-bg-color, #182230)'}}>
                                                <p className="font-semibold">{book.title}</p>
                                                <p className="text-sm" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>{book.author}</p>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => setAddNewBookModalOpen(true)} className="w-full mt-4 text-white font-bold p-3 rounded-md flex items-center justify-center transition-colors" style={{backgroundColor: '#007bff'}}>
                                        <SparklesIcon className="h-5 w-5 mr-2" /> ✨ Add New Book with AI
                                    </button>
                                     <button onClick={() => setStep(1)} className="w-full mt-2 text-white font-bold p-2 rounded-md transition-colors" style={{backgroundColor: '#6c757d'}}>Back</button>
                                </div>
                            )}

                            {step === 3 && (
                                <div>
                                    <label className="block text-lg font-semibold mb-2">3. How many pages have you read today?</label>
                                    <p className="mb-2" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>From "{selectedBook.title}"</p>
                                    <input type="number" value={pagesRead} onChange={e => setPagesRead(e.target.value)} placeholder="e.g., 30" className="w-full p-3 rounded-md border-0 outline-none" style={{backgroundColor: 'var(--tg-theme-bg-color, #182230)'}} />
                                    <div className="flex justify-between mt-6">
                                        <button onClick={() => setStep(2)} className="text-white font-bold px-6 py-2 rounded-md transition-colors" style={{backgroundColor: '#6c757d'}}>Back</button>
                                        <button onClick={handleConfirmLog} disabled={!pagesRead || isConfirming} className="text-white font-bold px-6 py-2 rounded-md transition-colors flex items-center" style={{backgroundColor: 'var(--tg-theme-button-color, #3390ec)'}}>
                                            {isConfirming ? <Spinner /> : 'Confirm'}
                                        </button>
                                    </div>
                                </div>
                            )}
                            
                            <button onClick={onClose} className="absolute top-4 right-4 text-2xl leading-none" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>&times;</button>
                        </div>
                    </div>
                </React.Fragment>
            );
        };
        
        // --- Add New Book Modal ---
        const AddNewBookModal = ({ onClose, onConfirm }) => {
            const [title, setTitle] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [preview, setPreview] = useState(null);
            const [error, setError] = useState(null);

            const handleFindBook = async (e) => {
                e.preventDefault();
                if (!title) return;
                setIsLoading(true);
                setError(null);
                setPreview(null);

                const prompt = `For the book titled "${title}", provide the author, a reasonable estimate for the total number of pages, and a concise one-paragraph summary.`;
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "author": { "type": "STRING" },
                                "totalPages": { "type": "NUMBER" },
                                "summary": { "type": "STRING" }
                            },
                            required: ["author", "totalPages", "summary"]
                        }
                    }
                };

                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0) {
                        const content = JSON.parse(result.candidates[0].content.parts[0].text);
                        setPreview({ title, ...content });
                    } else {
                        throw new Error("Could not find details for this book.");
                    }
                } catch (err) {
                    console.error("Error finding book:", err);
                    setError("Could not automatically find details for this book. Please try a different title.");
                } finally {
                    setIsLoading(false);
                }
            };

            const handleConfirmAdd = async () => {
                setIsLoading(true);
                await onConfirm(preview);
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 flex justify-center items-center p-4 z-[60]" style={{backgroundColor: 'rgba(0,0,0,0.8)'}}>
                    <div className="w-full max-w-lg p-6 rounded-xl relative" style={{backgroundColor: 'var(--tg-theme-secondary-bg-color, #2a3542)'}}>
                        <h2 className="text-2xl font-bold mb-4 flex items-center"><SparklesIcon className="mr-2 h-6 w-6"/> Add Book with AI</h2>
                        
                        {!preview ? (
                            <form onSubmit={handleFindBook} className="space-y-4">
                                <p style={{color: 'var(--tg-theme-hint-color, #999999)'}}>Enter the title of the book and we'll find the details for you.</p>
                                <input type="text" placeholder="Book Title (e.g., The Hobbit)" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-3 rounded-md border-0 outline-none" style={{backgroundColor: 'var(--tg-theme-bg-color, #182230)'}} required />
                                {error && <p className="text-sm" style={{color: 'var(--tg-theme-destructive-text-color, #ff4d4d)'}}>{error}</p>}
                                <div className="flex justify-end gap-4 pt-2">
                                    <button type="button" onClick={onClose} className="px-4 py-2 rounded-md" style={{backgroundColor: '#6c757d', color: 'white'}}>Cancel</button>
                                    <button type="submit" disabled={isLoading || !title} className="px-4 py-2 rounded-md text-white flex items-center" style={{backgroundColor: 'var(--tg-theme-button-color, #3390ec)'}}>
                                        {isLoading ? <Spinner /> : 'Find Book'}
                                    </button>
                                </div>
                            </form>
                        ) : (
                            <div className="space-y-4 animate-fade-in">
                                <h3 className="text-xl font-bold">{preview.title}</h3>
                                <p className="text-md" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>by {preview.author}</p>
                                <p className="text-md" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>~{preview.totalPages} pages</p>
                                <p className="p-3 rounded-lg" style={{backgroundColor: 'var(--tg-theme-bg-color, #182230)'}}>{preview.summary}</p>
                                <p style={{color: 'var(--tg-theme-hint-color, #999999)'}}>Does this look correct?</p>
                                <div className="flex justify-end gap-4 pt-2">
                                    <button type="button" onClick={() => setPreview(null)} className="px-4 py-2 rounded-md text-white" style={{backgroundColor: '#6c757d'}}>Try Again</button>
                                    <button onClick={handleConfirmAdd} disabled={isLoading} className="px-4 py-2 rounded-md text-white flex items-center" style={{backgroundColor: 'var(--tg-theme-button-color, #3390ec)'}}>
                                        {isLoading ? <Spinner /> : 'Yes, Add to Library'}
                                    </button>
                                </div>
                            </div>
                        )}
                        <button onClick={onClose} className="absolute top-4 right-4 text-2xl leading-none" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>&times;</button>
                    </div>
                </div>
            );
        };

        // NEW: Book Insights Modal
        const BookInsightsModal = ({ book, onClose }) => {
            const [insight, setInsight] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            const getInsight = async (type) => {
                setIsLoading(true);
                setInsight('');
                setError('');
                
                let prompt = '';
                if (type === 'characters') {
                    prompt = `Provide a brief analysis of the main characters in the book "${book.title}".`;
                } else if (type === 'themes') {
                    prompt = `What are the main themes explored in the book "${book.title}"? Explain each one briefly.`;
                }

                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0) {
                        setInsight(result.candidates[0].content.parts[0].text);
                    } else {
                        throw new Error("Could not generate insights for this book.");
                    }
                } catch (err) {
                    console.error("Error getting insight:", err);
                    setError("Sorry, I couldn't generate insights at this time.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 flex justify-center items-center p-4 z-50" style={{backgroundColor: 'rgba(0,0,0,0.7)'}}>
                    <div className="w-full max-w-2xl p-6 rounded-xl relative max-h-[90vh] flex flex-col" style={{backgroundColor: 'var(--tg-theme-secondary-bg-color, #2a3542)'}}>
                        <h2 className="text-2xl font-bold mb-1">{book.title}</h2>
                        <p className="mb-4" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>by {book.author}</p>
                        
                        <div className="flex gap-4 mb-4">
                            <button onClick={() => getInsight('characters')} disabled={isLoading} className="flex-1 text-white font-bold p-2 rounded-md flex items-center justify-center transition-colors" style={{backgroundColor: 'var(--tg-theme-button-color, #3390ec)'}}>
                                <SparklesIcon className="h-5 w-5 mr-2" /> ✨ Analyze Characters
                            </button>
                            <button onClick={() => getInsight('themes')} disabled={isLoading} className="flex-1 text-white font-bold p-2 rounded-md flex items-center justify-center transition-colors" style={{backgroundColor: 'var(--tg-theme-button-color, #3390ec)'}}>
                                <SparklesIcon className="h-5 w-5 mr-2" /> ✨ Explain Themes
                            </button>
                        </div>

                        <div className="flex-grow overflow-y-auto p-3 rounded-lg" style={{backgroundColor: 'var(--tg-theme-bg-color, #182230)'}}>
                            {isLoading && <Spinner size="h-8 w-8" />}
                            {error && <p style={{color: 'var(--tg-theme-destructive-text-color, #ff4d4d)'}}>{error}</p>}
                            {insight && <div className="whitespace-pre-wrap">{insight}</div>}
                            {!isLoading && !error && !insight && <p style={{color: 'var(--tg-theme-hint-color, #999999)'}}>Select an option above to get AI-powered insights about this book.</p>}
                        </div>

                        <button onClick={onClose} className="absolute top-4 right-4 text-2xl leading-none" style={{color: 'var(--tg-theme-hint-color, #999999)'}}>&times;</button>
                    </div>
                </div>
            );
        };

        // --- Root App Component ---
        const App = () => {
            const [db, setDb] = useState(null);
            const [tgUser, setTgUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [books, setBooks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            const appId = 'kitob-challenge-tg';

            // --- Initialization ---
            useEffect(() => {
                try {
                    // 1. Initialize Telegram & Create Mock User for Browser Testing
                    let user;
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user && window.Telegram.WebApp.initDataUnsafe.user.id) {
                        const tg = window.Telegram.WebApp;
                        tg.ready();
                        tg.expand();
                        user = tg.initDataUnsafe.user;
                    } else {
                        // Create a mock user for local browser testing
                        console.warn("Telegram context not found. Running in local test mode.");
                        user = {
                            id: 123456789,
                            first_name: "Local",
                            last_name: "Tester",
                            username: "local_tester",
                        };
                    }
                    setTgUser(user);
                    
                    // 2. Initialize Firebase
                    setLogLevel('debug');
                    
                    // ===================================================================
                    // IMPORTANT: PASTE YOUR FIREBASE CONFIG OBJECT HERE
                    // ===================================================================
                    // Import the functions you need from the SDKs you need
                    import { initializeApp } from "firebase/app";
                    import { getAnalytics } from "firebase/analytics";
                    // TODO: Add SDKs for Firebase products that you want to use
                    // https://firebase.google.com/docs/web/setup#available-libraries
                    
                    // Your web app's Firebase configuration
                    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
                    const firebaseConfig = {
                      apiKey: "AIzaSyAtqq96GDDTw2gQ8XR484IJhxdmeEaxuLk",
                      authDomain: "kitobchallenge.firebaseapp.com",
                      projectId: "kitobchallenge",
                      storageBucket: "kitobchallenge.firebasestorage.app",
                      messagingSenderId: "541058048837",
                      appId: "1:541058048837:web:359c76e3789e7b8ee8942c",
                      measurementId: "G-CN7JWZKGXF"
                    };
                    
                    // Initialize Firebase
                    const app = initializeApp(firebaseConfig);
                    const analytics = getAnalytics(app);
                    // ===================================================================

                    // NEW: Add a check for the placeholder API key
                    if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
                        setError("Firebase API Key is missing. Please edit the index.html file and add your Firebase configuration from the Firebase console.");
                        setIsLoading(false);
                        return;
                    }

                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const auth = getAuth(app);
                    setDb(firestore);

                    // 3. Sign in to Firebase to satisfy security rules
                    signInAnonymously(auth).catch(authError => {
                        console.error("Firebase Anonymous Auth Error:", authError);
                        setError("Could not connect to the database. Check your Firebase API key and security rules.");
                    });

                } catch (e) {
                    console.error("Initialization failed:", e);
                    setError("Could not initialize the application.");
                    setIsLoading(false);
                }
            }, []);

            // --- User Profile and Book Data Fetching ---
            useEffect(() => {
                if (!db || !tgUser) return;

                const userId = tgUser.id.toString();
                const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/info`);

                const handleProfile = async () => {
                    const docSnap = await getDoc(profileDocRef);
                    if (docSnap.exists()) {
                        setUserProfile(docSnap.data());
                    } else {
                        // Auto-register user on first visit
                        const newProfile = {
                            fullName: `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim(),
                            telegramId: tgUser.id,
                            username: tgUser.username || '',
                            createdAt: new Date(),
                        };
                        await setDoc(profileDocRef, newProfile);
                        setUserProfile(newProfile);
                    }
                };

                handleProfile().catch(err => {
                    console.error("Error handling profile:", err);
                    setError("Failed to load your profile. Please check your Firestore security rules.");
                }).finally(() => {
                     setIsLoading(false);
                });

                // Fetch Books
                const booksCollectionPath = `artifacts/${appId}/users/${userId}/books`;
                const q = query(collection(db, booksCollectionPath));
                const unsubscribeBooks = onSnapshot(q, (querySnapshot) => {
                    let booksData = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    // FIX: Sort books by creation date client-side
                    booksData.sort((a, b) => {
                        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : 0;
                        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : 0;
                        return dateB - dateA;
                    });
                    setBooks(booksData);
                }, (err) => {
                    console.error("Error fetching books:", err);
                    setError("Failed to fetch your books. Please check your Firestore indexes and rules.");
                });

                return () => unsubscribeBooks();
            }, [db, tgUser]);

            // --- Core Functions ---
            const handleAddNewBook = async (newBookData) => {
                if (!db || !tgUser) return null;
                const userId = tgUser.id.toString();
                const book = {
                    ...newBookData,
                    pagesRead: 0,
                    createdAt: new Date(),
                };
                try {
                    const booksCollectionPath = `artifacts/${appId}/users/${userId}/books`;
                    const docRef = await addDoc(collection(db, booksCollectionPath), book);
                    return { id: docRef.id, ...book };
                } catch (err) {
                    console.error("Error adding book:", err);
                    setError("Failed to add new book.");
                    return null;
                }
            };

            const handleLogReading = async ({ dayNumber, bookId, pagesRead }) => {
                if (!db || !tgUser) return null;
                const userId = tgUser.id.toString();
                const bookRef = doc(db, `artifacts/${appId}/users/${userId}/books/${bookId}`);
                
                try {
                    const bookDoc = await getDoc(bookRef);
                    if (!bookDoc.exists()) throw new Error("Book not found");

                    const bookData = bookDoc.data();
                    const newTotalPagesRead = (bookData.pagesRead || 0) + pagesRead;
                    
                    await updateDoc(bookRef, { pagesRead: newTotalPagesRead });

                    const prompt = `My friend ${userProfile.fullName} just read ${pagesRead} pages of "${bookData.title}". Write a short, encouraging, and personalized message for them about their progress. Keep it to one or two sentences.`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    let motivation = "Great session! Keep up the fantastic work.";
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                            motivation = result.candidates[0].content.parts[0].text.trim().replace(/"/g, '');
                        }
                    } catch (geminiError) {
                        console.error("Gemini API error:", geminiError);
                    }

                    return {
                        userName: userProfile.fullName,
                        dayNumber,
                        book: { ...bookData, pagesRead: newTotalPagesRead },
                        motivation
                    };

                } catch (err) {
                    console.error("Error logging reading:", err);
                    setError("Failed to log your reading session.");
                    return null;
                }
            };
            
            const handleDeleteBook = async (bookId) => {
                if (!db || !tgUser || !window.confirm("Are you sure you want to delete this book?")) return;
                const userId = tgUser.id.toString();
                const bookDocPath = `artifacts/${appId}/users/${userId}/books/${bookId}`;
                try {
                    await deleteDoc(doc(db, bookDocPath));
                } catch (err) {
                    console.error("Error deleting book:", err);
                    setError("Failed to delete the book.");
                }
            };

            // UPDATED: Render logic to show the new loading screen
            if (isLoading) {
                return <LoadingScreen />;
            }

            if (error) {
                 return (
                    <div className="flex items-center justify-center h-screen p-4">
                        <div className="p-4 rounded-lg text-center" style={{backgroundColor: 'var(--tg-theme-secondary-bg-color, #2a3542)'}}>
                            <strong className="font-bold">An Error Occurred</strong>
                            <p className="mt-2" style={{color: 'var(--tg-theme-destructive-text-color, #ff4d4d)'}}>{error}</p>
                        </div>
                    </div>
                );
            }

            return userProfile ? (
                <MainApp user={userProfile} books={books} onLogReading={handleLogReading} onAddNewBook={handleAddNewBook} onDeleteBook={handleDeleteBook} />
            ) : (
                 <div className="flex items-center justify-center h-screen"><Spinner size="h-12 w-12" /></div> // Fallback spinner if profile is still loading
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
